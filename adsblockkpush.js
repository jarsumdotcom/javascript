(function () { 'use strict'; class Pushes { constructor(options) { this.initialize(); } initData() { /** * Эта часть генерируется на бэке. Вынес отдельно для читаемости * @type {{ * webmaster_id: number, * iframeUrl: string, * fetchUrl: string, * locationServiceWorker: string * }} */ this.jdata = { webmaster_id: '45004', iframeUrl: "https://adsblockkpush.com/v1/iframe/45004.html", fetchUrl: 'https://adsblockkpush.com/v1/event/subscribe', locationServiceWorker: '/swnhrj.js', forcehttp: '' || this.scriptParams.http, }; this.data = { webmaster_id: this.jdata.webmaster_id, apiKey: 'BAP8yJU32Iu9nXb7aIpQ6rWwgZc8qxmibKyeGWNM5dHZWKW5HlGGu54ooSPXzUqX8chN4NXEBPhlZYjEbr7opyU', domain: location.hostname, fetchUrl: this.jdata.fetchUrl, iframeUrl: this.jdata.iframeUrl, // iframe должен обязательно находиться на https originHostName: location.hostname, locationServiceWorker: this.jdata.locationServiceWorker, showDelay: 2000, // Ms capping: { id: 'dFsxplJLaH', showInterval: 24, // hours identityExpire: 30 // days }, forcehttp: this.jdata.forcehttp, httpProtocol: location.protocol.replace(':', ''), // https: -> https language: navigator.language.split('-')[0], // ru-RU, en-US isIframe: this.urlParams['isIframe'] || false, }; this.ids = { tokenId: getAndSetToken.call(this) || null, }; this.stats = { sub1: '' || this.scriptParams.sub1 || this.urlParams['sub1'], sub2: '' || this.scriptParams.sub2 || this.urlParams['sub2'], sub3: '' || this.scriptParams.sub3 || this.urlParams['sub3'], sub4: '' || this.scriptParams.sub4 || this.urlParams['sub4'], utm_campaign: this.scriptParams['utm_campaign'] || this.urlParams['utm_campaign'], utm_source: this.scriptParams['utm_source'] || this.urlParams['utm_source'], utm_medium: this.scriptParams['utm_medium'] || this.urlParams['utm_medium'], utm_content: this.scriptParams['utm_content'] || this.urlParams['utm_content'], utm_term: this.scriptParams['utm_term'] || this.urlParams['utm_term'], click_id: this.scriptParams['clickid'] || this.urlParams['clickid'] }; this.translate = { "am": { "block": "አግድ", "allow": "ፍቀድ", "des_request": `${this.data.domain} የሚከተሉትን ማድረግ ይፈልጋል፦`, "des_show": "ማሳወቂያዎችን አሳይ", }, "ar": { "block": "منع", "allow": "سماح", "des_request": `يريد ${this.data.domain}`, "des_show": "عرض الإشعارات", }, "bg": { "block": "Блокиране", "allow": "Разрешаване", "des_request": `${this.data.domain} иска да`, "des_show": "Показва известия", }, "ca": { "block": "Bloqueja", "allow": "Permet", "des_request": `${this.data.domain} vol`, "des_show": "Mostrar notificacions", }, "cs": { "block": "Blokovat", "allow": "Povolit", "des_request": `Web ${this.data.domain} chce`, "des_show": "Zobrazovat oznámení", }, "da": { "block": "Bloker", "allow": "Tillad", "des_request": `${this.data.domain} vil gerne`, "des_show": "Vise underretninger", }, "de": { "block": "Blockieren", "allow": "Zulassen", "des_request": `${this.data.domain} möchte:`, "des_show": "Benachrichtigungen anzeigen", }, "el": { "block": "Αποκλεισμός", "allow": "Επιτρέπεται", "des_request": `Ο ιστότοπος ${this.data.domain} επιθυμεί`, "des_show": "Εμφάνιση ειδοποιήσεων", }, "en": { "block": "Block", "allow": "Allow", "des_request": `${this.data.domain} wants to`, "des_show": "Show notifications", }, "es-419": { "block": "Bloquear", "allow": "Permitir", "des_request": `${this.data.domain} quiere`, "des_show": "Mostrar notificaciones", }, "es": { "block": "Bloquear", "allow": "Permitir", "des_request": `${this.data.domain} quiere`, "des_show": "Mostrar notificaciones", }, "fa": { "block": "مسدود کردن", "allow": "اجازه دادن", "des_request": `${this.data.domain} می‌خواهد`, "des_show": "نمایش اعلان‌ها", }, "fi": { "block": "Estä", "allow": "Salli", "des_request": `${this.data.domain} pyytää lupaa`, "des_show": "Näytä ilmoitukset", }, "fil": { "block": "I-block", "allow": "Payagan", "des_request": `Gusto ng ${this.data.domain} na`, "des_show": "Ipakita ang mga notification", }, "fr": { "block": "Bloquer", "allow": "Autoriser", "des_request": `${this.data.domain} veut:`, "des_show": "Afficher les notifications", }, "hi": { "block": "अवरोधित करें", "allow": "अनुमति दें", "des_request": `${this.data.domain} यह करना चाहती है:`, "des_show": "नोटिफ़िकेशन दिखाएं", }, "hr": { "block": "Blokiraj", "allow": "Dopusti", "des_request": `${this.data.domain} želi`, "des_show": "Prikazati obavijesti", }, "hu": { "block": "Letiltás", "allow": "Engedélyezés", "des_request": `A(z) ${this.data.domain} a következőket szeretné tenni:`, "des_show": "Értesítéseket megjeleníteni", }, "id": { "block": "Blokir", "allow": "Izinkan", "des_request": `${this.data.domain} ingin`, "des_show": "Tampilkan notifikasi", }, "it": { "block": "Blocca", "allow": "Consenti", "des_request": `${this.data.domain} vorrebbe`, "des_show": "Mostrare le notifiche", }, "iw": { "block": "חסום", "allow": "אפשר", "des_request": ` רוצה${this.data.domain}`, "des_show": "תראה התראות", }, "ja": { "block": "ブロック", "allow": "許可", "des_request": `${this.data.domain} が次の許可を求めています`, "des_show": "通知の表示", }, "ko": { "block": "차단", "allow": "허용", "des_request": `${this.data.domain}에서 다음 권한을 요청합니다.`, "des_show": "알림 표시", }, "lt": { "block": "Blokuoti", "allow": "Leisti", "des_request": `${this.data.domain} nori`, "des_show": "Rodyti pranešimus", }, "lv": { "block": "Bloķēt", "allow": "Atļaut", "des_request": `Vietne ${this.data.domain} vēlas:`, "des_show": "Rādīt paziņojumus", }, "nl": { "block": "Blokkeren", "allow": "Toestaan", "des_request": `${this.data.domain} wil het volgende`, "des_show": "Meldingen weergeven", }, "no": { "block": "Blokkér", "allow": "Tillat", "des_request": `${this.data.domain} vil`, "des_show": "Vis varsler", }, "pl": { "block": "Blokuj", "allow": "Zezwalaj", "des_request": `${this.data.domain} prosi o pozwolenie na:`, "des_show": "Pokazywanie powiadomień", }, "pt-BR": { "block": "Bloquear", "allow": "Permitir", "des_request": `${this.data.domain} deseja`, "des_show": "Mostrar notificações", }, "pt": { "block": "Bloquear", "allow": "Permitir", "des_request": `${this.data.domain} pretende`, "des_show": "Mostrar notificações", }, "ro": { "block": "Blochează", "allow": "Permite", "des_request": `${this.data.domain} dorește să`, "des_show": "Afișeze notificări", }, "ru": { "block": "Блокировать", "allow": "Разрешить", "des_request": `Сайт ${this.data.domain} запрашивает разрешение на:`, "des_show": "Показ уведомлений", }, "sk": { "block": "Blokovať", "allow": "Povoliť", "des_request": `${this.data.domain} vyžaduje`, "des_show": "Zobrazovať upozornenia", }, "sl": { "block": "Blokiraj", "allow": "Dovoli", "des_request": `${this.data.domain} želi`, "des_show": "Pokaži obvestila", }, "sr": { "block": "Блокирај", "allow": "Дозволи", "des_request": `${this.data.domain} жели да`, "des_show": "приказује обавештења", }, "sv": { "block": "Blockera", "allow": "Tillåt", "des_request": `${this.data.domain} vill`, "des_show": "Visa aviseringar", }, "sw": { "block": "Zuia", "allow": "Ruhusu", "des_request": `${this.data.domain} inataka`, "des_show": "Kuonyesha arifa", }, "th": { "block": "บล็อก", "allow": "อนุญาต", "des_request": `${this.data.domain} ต้องการที่จะ`, "des_show": "แสดงการแจ้งเตือน", }, "tr": { "block": "Engelle", "allow": "İzin ver", "des_request": `${this.data.domain} şunu yapmak istiyor:`, "des_show": "Bildirimleri gösterme", }, "uk": { "block": "Блокувати", "allow": "Дозволити", "des_request": `Сайт ${this.data.domain} хоче`, "des_show": "показувати сповіщення", }, "vi": { "block": "Chặn", "allow": "Cho phép", "des_request": `${this.data.domain} muốn`, "des_show": "Hiển thị thông báo", }, "zh": { "block": "禁止", "allow": "允许", "des_request": `${this.data.domain} 想要`, "des_show": "显示通知", }, "zh-TW": { "block": "封鎖", "allow": "允許", "des_request": `${this.data.domain} 要求下列權限：`, "des_show": "顯示通知", }, "bn": { "block": "ব্লক করুন", "allow": "অনুমতি দিন", "des_request": `${this.data.domain} চায়`, "des_show": "বিজ্ঞপ্তিগুলি দেখান", }, "et": { "block": "Blokeeri", "allow": "Luba", "des_request": `${this.data.domain} soovib`, "des_show": "märguandeid näidata", }, "gu": { "block": "અવરોધિત કરો", "allow": "મંજૂરી આપો", "des_request": `${this.data.domain} આ કરવા માંગે છે`, "des_show": "સૂચનાઓ દર્શાવો", }, "kn": { "block": "ನಿರ್ಬಂಧಿಸು", "allow": "ಅನುಮತಿಸಿ", "des_request": `${this.data.domain} ಹೀಗೆ ಬಯಸುತ್ತದೆ`, "des_show": "ಅಧಿಸೂಚನೆಗಳನ್ನು ತೋರಿಸಿ", }, "ml": { "block": "തടയുക", "allow": "അനുവദിക്കൂ", "des_request": `${this.data.domain} ഇത് ചെയ്യാൻ താൽപ്പര്യപ്പെടുന്നു`, "des_show": "അറിയിപ്പുകൾ കാണിക്കുക", }, "mr": { "block": "अवरोधित करा", "allow": "परवानगी द्या", "des_request": `${this.data.domain} हे करू इच्छिते`, "des_show": "सूचना दर्शवा", }, "ms": { "block": "Sekat", "allow": "Benarkan", "des_request": `${this.data.domain} ingin`, "des_show": "Tunjukkan pemberitahuan", }, "ta": { "block": "தடு", "allow": "அனுமதி", "des_request": `${this.data.domain} பின்வருவனவற்றைச் செய்ய விரும்புகிறது:`, "des_show": "அறிவிப்புகளைக் காட்டுதல்", }, "te": { "block": "నిరోధించు", "allow": "అనుమతించు", "des_request": `${this.data.domain} వీటిని చేయాలనుకుంటోంది`, "des_show": "నోటిఫికేషన్‌లను చూపాలనుకుంటోంది", } } ; this.design = { iframe: { width: 500, height: 500 }, }; } httpInit() { let modalDescriptionId = getUniqueId('_'); let btnApproveIconId = getUniqueId('_'); let modalRowClass = getUniqueId('_'); let modalRowBtnId = getUniqueId('_'); let btnIdApprove = getUniqueId('_'); let modalTitleId = getUniqueId('_'); let btnIdCancel = getUniqueId('_'); let modalId = getUniqueId('_'); let btnApproveIcon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAPCAYAAADQ4S5JAAAA0klEQVQokY2SMQ5BQRCGv/UUonIBOgXFO4GOzgXkTacVJ9ByAq4wUb1SpXUCBQdwAVGIRGIVlmx2n5f3VzPzz5eZya6x1hJKROYAqroOPRMCItIDTi7tq+rZ92tB8xTIvVLuavEEEZkBm2i/j+aquvkBItIGjkDrD3AFUlW9fFcaljTjvJF/Q6ek+au2DyQVgMQH4seIZX3gWQF4+kC3AtAFMFmWLYFFBQBgVQdSYA+8XPEB3F3cBBourgFp0V8aAGOX7lT14Pv1grE3YAIYYBuab48iOg8QFOAhAAAAAElFTkSuQmCC"; // Init style node and append @ head let style = document.createElement('style'); style.innerHTML = ` #${modalId} { font-size: 14px; color: gray; border-radius: 4px; box-shadow: rgba(0, 0, 0, 0.7) 0px 0px 10px; transition: all 0.3s ease-in-out; position: fixed; top: 20px; left: -500px; opacity: 1; cursor: default; background-color: rgb(255, 255, 255); width: 300px; padding: 20px; text-align: center; z-index: 2147483647; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygdeen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; } #${modalRowBtnId} { display: flex; width: 100%; align-items: center; justify-content: space-between; } #${modalTitleId} { } #${modalDescriptionId} { display: inline-block; margin-top: 0; margin-bottom: 25px; } #${btnIdApprove}, #${btnIdCancel} { cursor: pointer; } #${btnIdCancel} { cursor: pointer; margin-right: 7px; } #${btnIdApprove} { color: #52dc5e; padding: 5px; } #${btnApproveIconId} { margin-right: 10px; margin-bottom: -2px; } .anim_${modalId} { left: 20px !important; } @media screen and (max-width: ${typeof window.orientation !== 'undefined' ? window.innerWidth : 900}px) { #${modalId} { bottom: 0; top: auto; width: 100%; left: 0; right: 0; display: flex; flex-direction: column; flex-wrap: wrap; align-items: center; justify-content: flex-end; box-sizing: border-box; margin-bottom: -500px; } #${btnIdApprove}, #${btnIdCancel} { padding: 10px; border: 1px lightgray solid; border-radius: 4px; text-transform: uppercase; } #${btnIdApprove} { color: #fff; background: #2196F3; } #${btnApproveIconId} { display: none; } .anim_${modalId} { left: 0 !important; margin-bottom: 0px !important; } } `; document.head.appendChild(style); let translate = this.translate[this.data.language] || this.translate['en']; // Init push message and append @ body let modalNode = document.createElement('div'); modalNode.setAttribute('id', modalId); modalNode.innerHTML = ` <div class="${modalRowClass}"><span id="${modalTitleId}">${translate.des_request}</span></div><div class="${modalRowClass}"><span id="${modalDescriptionId}">${translate.des_show}</span></div><div id="${modalRowBtnId}"><span id="${btnIdCancel}">${translate.block}</span><span id="${btnIdApprove}"><img id="${btnApproveIconId}" src="${btnApproveIcon}"/> ${translate.allow} </span></div>`; document.body.appendChild(modalNode); setTimeout(() => modalNode.classList.add(`anim_${modalId}`), 250); let btnCancelNode = document.getElementById(btnIdCancel); let btnApproveNode = document.getElementById(btnIdApprove); // init button events btnCancelNode.addEventListener('click', event => { event.preventDefault(); event.stopPropagation(); setCappingDate.call(this); // Trigger animation modalNode.classList.remove(`anim_${modalId}`); }); btnApproveNode.addEventListener('click', event => { event.preventDefault(); event.stopPropagation(); // Convert subs in query get let subs = Object.keys(this.stats).filter(value => this.stats[value]).map(value => `${value}=${this.stats[value]}`).join('&'); let additionalParams = `?webmaster_id=${this.data.webmaster_id}&host=${location.host}&${subs}&isIframe=true`; let iframeHeight = this.design.iframe.height; let iframeWidth = this.design.iframe.width; let topPosition = Math.max(0, (screen.availHeight - iframeHeight)/2); let leftPosition = Math.max(0, (screen.availWidth - iframeWidth)/2); let parameters = `scrollbars=1,height=${iframeHeight},width=${iframeWidth},left=${leftPosition},top=${topPosition}`; window.open(this.data.iframeUrl+additionalParams, null, parameters); setCappingDate.call(this); // Trigger animation modalNode.classList.remove(`anim_${modalId}`); }); } initialize() { createGetQueryParams(this.urlParams = {}); this.initScriptParams('phie7Eep'); this.initData(); this.initEvents(); this.startPush(); } initScriptParams(id) { let nodeScript = document.getElementById(id); const scriptParams = nodeScript ? nodeScript.src : ''; createGetQueryParams(this.scriptParams= {}, scriptParams); } startPush() { let pauseBeforeInit = this.data.isIframe ? 0 : this.data.showDelay; if (('Notification' in window) && !checkCappingDate.call(this)) { setTimeout(() => { if (this.data.httpProtocol === 'http') { this.httpInit() } else if (this.data.httpProtocol === 'https' && !this.data.forcehttp) { this.httpsInit() } else if (this.data.forcehttp) { this.httpInit() } }, pauseBeforeInit) } } httpsInit() { getAndSetToken.call(this); requestPermission.call(this); } initEvents() { this.events = { onRequestDenied: new Event('onRequestDenied'), onRequestApproved: new Event('onRequestApproved') }; } } function createGetQueryParams(writeLocation, parseLocation = window.location.search.substring(1)) { let match; let pl = /\+/g; // Regex for replacing addition symbol with a space let search = /([^&=]+)=?([^&]*)/g; let decode = s => decodeURIComponent(s.replace(pl, " ")); while (match = search.exec(parseLocation)) writeLocation[decode(match[1])] = decode(match[2]); } function getUniqueId(prefix = '', postfix = '') { let gen = () => Math.floor((1 + Math.random()) * 0x10000).toString(36).substring(1); return prefix + gen() + gen() + gen() + gen() + postfix } function urlBase64ToUint8Array(base64String) { const padding = '='.repeat((4 - base64String.length % 4) % 4); const base64 = (base64String + padding) .replace(/\-/g, '+') .replace(/_/g, '/'); const rawData = window.atob(base64); return Uint8Array.from([...rawData].map((char) => char.charCodeAt(0))); } function getCookie(name) { let matches = document.cookie.match(new RegExp( "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)" )); return matches ? decodeURIComponent(matches[1]) : null; } function setCookie(name, value, options) { options = options || {}; let expires = options.expires; if (typeof expires === "number" && expires) { let date = new Date(); date.setTime(date.getTime() + expires * 1000); expires = options.expires = date; } if (expires && expires.toUTCString) { options.expires = expires.toUTCString(); } value = encodeURIComponent(value); let updatedCookie = name + "=" + value; for (let propName in options) { updatedCookie += "; " + propName; let propValue = options[propName]; if (propValue !== true) { updatedCookie += "=" + propValue; } } document.cookie = updatedCookie; } function requestPermission() { Notification.requestPermission() .then(result => { if (result.toLowerCase() === 'granted') { document.body.dispatchEvent(this.events.onRequestApproved); onRequestApproved.call(this, result) } else { document.body.dispatchEvent(this.events.onRequestDenied); onRequestDenied.call(this, result) } }); } function checkCappingDate() { let cappingData = this.data.capping; let dateExpire = localStorage.getItem(cappingData.id); let capping = dateExpire || getCookie(cappingData.id); if (capping) { let validateLocalStorage = new Date() < new Date(dateExpire); return validateLocalStorage || getCookie(cappingData.id) } return false } function setCappingDate(expireTime = this.data.capping.showInterval /*hours*/) { let cappingData = this.data.capping; let expireDate = new Date(new Date().getTime() + (expireTime * 3600) * 1000); localStorage.setItem(cappingData.id, expireDate); setCookie(cappingData.id, getUniqueId(), { domain: `.${this.data.domain}`, expires: expireDate.toUTCString() }); } function installWorker() { if ('serviceWorker' in navigator) { navigator.serviceWorker.register('//' + location.host + this.data.locationServiceWorker) .then(() => { navigator.serviceWorker.ready .then(rWorker => { rWorker.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(this.data.apiKey) }) .then((pushSubscription) => { sendSubscription.call(this, pushSubscription) }) }); }); } else { console.warn('Service workers aren\'t supported in this browser.'); } } function getAndSetToken(expireTime = this.data.capping.identityExpire /*days*/) { let token = getCookie('tokenId'); if (!token) { let expireDate = new Date(new Date().getTime() + (expireTime * 86400) * 1000); token = getUniqueId('t_'); setCookie('tokenId', token, { domain: `.${this.data.domain}`, expires: expireDate.toUTCString() }) } return token; } function sendSubscription(pushSubscription) { let keys = pushSubscription.toJSON().keys; fetch(this.data.fetchUrl, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ webmaster_id: this.data.webmaster_id, event_id: 'subscribe', subscription_id: pushSubscription.endpoint, auth_secret: keys.auth, public_key: keys.p256dh, referrer: document.referrer, origin: location.host + location.pathname, host: location.host, lang: navigator.language, datestamp: Date.now(), timezone: new Date().getTimezoneOffset(), //time zone in minutes scheme: this.data.httpProtocol, sub1: this.stats.sub1 || null, sub2: this.stats.sub2 || null, sub3: this.stats.sub3 || null, sub4: this.stats.sub4 || null, utm_campaign: this.stats['utm_campaign'] || null, utm_source: this.stats['utm_source'] || null, utm_medium: this.stats['utm_medium'] || null, utm_content: this.stats['utm_content'] || null, utm_term: this.stats['utm_term'] || null, click_id: this.stats['click_id'] || null, device_id: this.ids.tokenId, device_resolution: screen.availWidth + 'x' + screen.availHeight }) }).then(response => { console.log('subscribe success', response); this.data.isIframe ? window.close() : false; }); } function onRequestApproved(res) { document.body.dispatchEvent(this.events.onRequestApproved); console.log('on request approved', res); installWorker.call(this); } function onRequestDenied(res) { document.body.dispatchEvent(this.events.onRequestDenied); console.log('requestPermission denied', res); this.data.isIframe ? window.close() : false; } (() => window[getUniqueId('h')] = new Pushes)(); })();
